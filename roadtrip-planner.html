<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aix-en-Provence Road Trip Planner</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #ffffff;
            color: #333;
            line-height: 1.6;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            font-weight: 700;
        }

        .header p {
            opacity: 0.95;
            font-size: 1.1rem;
        }

        .container {
            display: flex;
            height: calc(100vh - 120px);
            position: relative;
        }

        .sidebar {
            width: 380px;
            background: #f8f9fa;
            padding: 1.5rem;
            overflow-y: auto;
            border-right: 1px solid #e0e0e0;
        }

        .map-container {
            flex: 1;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .control-group {
            margin-bottom: 1.5rem;
            background: white;
            padding: 1.25rem;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }

        .control-group h3 {
            margin-bottom: 0.75rem;
            color: #555;
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .input-container {
            position: relative;
        }

        input[type="text"], input[type="password"] {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus, input[type="password"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
        }

        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 6px 6px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .autocomplete-item {
            padding: 0.75rem;
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 1px solid #f0f0f0;
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .autocomplete-item:hover, .autocomplete-item.selected {
            background: #f5f7fa;
        }

        .theme-selector {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
        }

        .theme-button {
            padding: 0.6rem;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
            text-align: center;
        }

        .theme-button:hover {
            border-color: #667eea;
            background: #f5f7fa;
        }

        .theme-button.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .slider-group {
            margin-bottom: 1rem;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            color: #666;
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e0e0e0;
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            width: 100%;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102,126,234,0.3);
        }

        .btn-secondary {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
            margin-right: 0.5rem;
        }

        .btn-secondary:hover {
            background: #667eea;
            color: white;
        }

        .btn-ai {
            background: linear-gradient(135deg, #00c9ff 0%, #92fe9d 100%);
            color: #333;
            padding: 0.6rem 1rem;
            font-size: 0.9rem;
            margin: 0.25rem;
        }

        .btn-ai:hover {
            transform: scale(1.05);
        }

        .route-info {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            margin-top: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .route-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .stat {
            text-align: center;
            padding: 0.75rem;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 0.85rem;
            color: #666;
            margin-top: 0.25rem;
        }

        .stops-list {
            margin-top: 1.5rem;
        }

        .stop-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: start;
            transition: all 0.3s;
        }

        .stop-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateX(4px);
        }

        .stop-number {
            background: #667eea;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 1rem;
            flex-shrink: 0;
        }

        .stop-content {
            flex: 1;
        }

        .stop-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: #333;
        }

        .stop-activities {
            font-size: 0.85rem;
            color: #666;
            margin-top: 0.5rem;
        }

        .stop-remove {
            background: #ff4444;
            color: white;
            border: none;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: background 0.3s;
        }

        .stop-remove:hover {
            background: #cc0000;
        }

        .ai-results {
            display: none;
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .ai-results.active {
            display: block;
        }

        .ai-result-content {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 6px;
            margin-top: 1rem;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #fee;
            color: #c33;
            padding: 0.75rem;
            border-radius: 6px;
            margin-top: 0.5rem;
            font-size: 0.9rem;
        }

        .export-buttons {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
                border-right: none;
                border-bottom: 1px solid #e0e0e0;
            }

            .map-container {
                height: 400px;
            }

            .theme-selector {
                grid-template-columns: repeat(2, 1fr);
            }

            .route-stats {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🚗 Aix-en-Provence Road Trip Planner</h1>
        <p>Discover the perfect route through Provence, the French Riviera, and beyond</p>
    </div>

    <div class="container">
        <div class="sidebar">
            <div class="control-group">
                <h3>Destination</h3>
                <div class="input-container">
                    <input type="text" id="destination" placeholder="Type a city name..." autocomplete="off">
                    <div class="autocomplete-dropdown" id="autocomplete"></div>
                </div>
            </div>

            <div class="control-group">
                <h3>Trip Theme</h3>
                <div class="theme-selector">
                    <button class="theme-button" data-theme="balanced">Balanced</button>
                    <button class="theme-button" data-theme="adventure">Adventure</button>
                    <button class="theme-button" data-theme="romantic">Romantic</button>
                    <button class="theme-button" data-theme="cultural">Cultural</button>
                    <button class="theme-button" data-theme="hidden">Hidden Gems</button>
                    <button class="theme-button" data-theme="family">Family</button>
                </div>
            </div>

            <div class="control-group">
                <h3>Route Options</h3>
                <div class="slider-group">
                    <div class="slider-label">
                        <span>Number of Stops</span>
                        <span id="stops-value">3</span>
                    </div>
                    <input type="range" id="stops-slider" min="1" max="6" value="3">
                </div>
                <div class="slider-group">
                    <div class="slider-label">
                        <span>Detour Tolerance</span>
                        <span id="detour-value">20%</span>
                    </div>
                    <input type="range" id="detour-slider" min="10" max="50" value="20" step="5">
                </div>
            </div>

            <button class="btn btn-primary" id="calculate-btn">Calculate Route</button>

            <div class="control-group" style="margin-top: 2rem;">
                <h3>AI Travel Assistant</h3>
                <input type="password" id="api-key" placeholder="Enter Perplexity API Key" style="margin-bottom: 1rem;">
                <div style="display: flex; flex-wrap: wrap;">
                    <button class="btn btn-ai" onclick="aiTripNarrator()">📖 Trip Narrator</button>
                    <button class="btn btn-ai" onclick="aiLocalFood()">🍽️ Local Food</button>
                    <button class="btn btn-ai" onclick="aiWeatherAdvice()">🌤️ Weather</button>
                    <button class="btn btn-ai" onclick="aiHiddenGems()">💎 Hidden Gems</button>
                    <button class="btn btn-ai" onclick="aiItinerary()">📅 Full Itinerary</button>
                </div>
            </div>

            <div class="ai-results" id="ai-results">
                <h3 id="ai-title">AI Insights</h3>
                <div class="ai-result-content" id="ai-content"></div>
            </div>

            <div class="route-info" id="route-info" style="display: none;">
                <div class="route-stats">
                    <div class="stat">
                        <div class="stat-value" id="total-distance">0</div>
                        <div class="stat-label">Kilometers</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="total-time">0</div>
                        <div class="stat-label">Hours</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="total-stops">0</div>
                        <div class="stat-label">Stops</div>
                    </div>
                </div>

                <div class="export-buttons">
                    <button class="btn btn-secondary" onclick="exportToGoogle()">📍 Google Maps</button>
                    <button class="btn btn-secondary" onclick="exportGPX()">📁 Download GPX</button>
                </div>

                <div class="stops-list" id="stops-list"></div>
            </div>
        </div>

        <div class="map-container">
            <div id="map"></div>
        </div>
    </div>

    <script>
        // Complete cities database with real data
        const cities = [
            // Starting point
            {
                id: "aix-en-provence",
                name: "Aix-en-Provence",
                lat: 43.5263,
                lon: 5.4454,
                country: "FR",
                population: 147933,
                themes: {
                    adventure: 0.4,
                    romantic: 0.8,
                    cultural: 0.9,
                    hidden: 0.2,
                    family: 0.7
                },
                activities: [
                    "Cours Mirabeau fountain walk",
                    "Cézanne's studio visit",
                    "Granet Museum art collection",
                    "Thermal spa wellness"
                ]
            },
            // French Riviera cities
            {
                id: "nice",
                name: "Nice",
                lat: 43.7102,
                lon: 7.262,
                country: "FR",
                population: 343875,
                themes: {
                    adventure: 0.5,
                    romantic: 0.9,
                    cultural: 0.8,
                    hidden: 0.1,
                    family: 0.8
                },
                activities: [
                    "Promenade des Anglais sunset walk",
                    "Castle Hill panoramic views",
                    "Old Town (Vieux Nice) exploration",
                    "Cours Saleya flower market"
                ]
            },
            {
                id: "cannes",
                name: "Cannes",
                lat: 43.5528,
                lon: 7.0174,
                country: "FR",
                population: 73603,
                themes: {
                    adventure: 0.3,
                    romantic: 0.9,
                    cultural: 0.7,
                    hidden: 0.1,
                    family: 0.6
                },
                activities: [
                    "La Croisette boulevard stroll",
                    "Film Festival Palace visit",
                    "Îles de Lérins boat trip",
                    "Le Suquet old quarter"
                ]
            },
            {
                id: "antibes",
                name: "Antibes",
                lat: 43.5804,
                lon: 7.1251,
                country: "FR",
                population: 76994,
                themes: {
                    adventure: 0.5,
                    romantic: 0.8,
                    cultural: 0.8,
                    hidden: 0.3,
                    family: 0.7
                },
                activities: [
                    "Picasso Museum visit",
                    "Cap d'Antibes coastal walk",
                    "Provençal market shopping",
                    "Port Vauban yacht watching"
                ]
            },
            {
                id: "monaco",
                name: "Monaco",
                lat: 43.7384,
                lon: 7.4246,
                country: "MC",
                population: 39244,
                themes: {
                    adventure: 0.4,
                    romantic: 0.9,
                    cultural: 0.7,
                    hidden: 0.1,
                    family: 0.6
                },
                activities: [
                    "Prince's Palace changing of guard",
                    "Monte Carlo Casino visit",
                    "Oceanographic Museum exploration",
                    "Japanese Garden meditation"
                ]
            },
            {
                id: "menton",
                name: "Menton",
                lat: 43.7765,
                lon: 7.5046,
                country: "FR",
                population: 28833,
                themes: {
                    adventure: 0.3,
                    romantic: 0.8,
                    cultural: 0.7,
                    hidden: 0.4,
                    family: 0.6
                },
                activities: [
                    "Lemon Festival celebration",
                    "Jean Cocteau Museum visit",
                    "Serre de la Madone gardens",
                    "Old Town colorful streets"
                ]
            },
            {
                id: "saint-tropez",
                name: "Saint-Tropez",
                lat: 43.2677,
                lon: 6.6407,
                country: "FR",
                population: 4103,
                themes: {
                    adventure: 0.6,
                    romantic: 0.9,
                    cultural: 0.6,
                    hidden: 0.2,
                    family: 0.5
                },
                activities: [
                    "Old Port celebrity spotting",
                    "Citadel maritime museum",
                    "Pampelonne Beach sunbathing",
                    "Place des Lices market"
                ]
            },
            // Italian cities
            {
                id: "venice",
                name: "Venice",
                lat: 45.4408,
                lon: 12.3155,
                country: "IT",
                population: 261905,
                themes: {
                    adventure: 0.3,
                    romantic: 1.0,
                    cultural: 1.0,
                    hidden: 0.2,
                    family: 0.5
                },
                activities: [
                    "St. Mark's Basilica tour",
                    "Gondola canal ride",
                    "Rialto Bridge crossing",
                    "Murano glass workshop"
                ]
            },
            {
                id: "florence",
                name: "Florence",
                lat: 43.7696,
                lon: 11.2558,
                country: "IT",
                population: 382258,
                themes: {
                    adventure: 0.3,
                    romantic: 0.8,
                    cultural: 1.0,
                    hidden: 0.2,
                    family: 0.6
                },
                activities: [
                    "Uffizi Gallery masterpieces",
                    "Duomo dome climb",
                    "Ponte Vecchio shopping",
                    "Boboli Gardens stroll"
                ]
            },
            {
                id: "milan",
                name: "Milan",
                lat: 45.4642,
                lon: 9.19,
                country: "IT",
                population: 1396059,
                themes: {
                    adventure: 0.4,
                    romantic: 0.6,
                    cultural: 0.8,
                    hidden: 0.1,
                    family: 0.6
                },
                activities: [
                    "Duomo cathedral rooftop",
                    "La Scala opera house",
                    "Galleria Vittorio Emanuele II shopping",
                    "Navigli canals aperitivo"
                ]
            },
            {
                id: "turin",
                name: "Turin",
                lat: 45.0703,
                lon: 7.6869,
                country: "IT",
                population: 870456,
                themes: {
                    adventure: 0.5,
                    romantic: 0.7,
                    cultural: 0.9,
                    hidden: 0.4,
                    family: 0.7
                },
                activities: [
                    "Egyptian Museum treasures",
                    "Royal Palace tour",
                    "Mole Antonelliana view",
                    "Authentic aperitivo experience"
                ]
            },
            {
                id: "genoa",
                name: "Genoa",
                lat: 44.4056,
                lon: 8.9463,
                country: "IT",
                population: 580223,
                themes: {
                    adventure: 0.6,
                    romantic: 0.6,
                    cultural: 0.8,
                    hidden: 0.5,
                    family: 0.7
                },
                activities: [
                    "Via del Campo palaces",
                    "Aquarium of Genoa visit",
                    "Focaccia bread tasting",
                    "Spianata Castelletto views"
                ]
            },
            {
                id: "verona",
                name: "Verona",
                lat: 45.4384,
                lon: 10.9916,
                country: "IT",
                population: 259610,
                themes: {
                    adventure: 0.4,
                    romantic: 0.9,
                    cultural: 0.9,
                    hidden: 0.3,
                    family: 0.7
                },
                activities: [
                    "Juliet's Balcony visit",
                    "Roman Arena opera",
                    "Piazza delle Erbe market",
                    "Castelvecchio fortress"
                ]
            },
            {
                id: "padua",
                name: "Padua",
                lat: 45.4064,
                lon: 11.8768,
                country: "IT",
                population: 214198,
                themes: {
                    adventure: 0.3,
                    romantic: 0.6,
                    cultural: 0.9,
                    hidden: 0.4,
                    family: 0.6
                },
                activities: [
                    "Scrovegni Chapel frescoes",
                    "University of Padua tour",
                    "Prato della Valle square",
                    "Botanical Garden visit"
                ]
            },
            {
                id: "brescia",
                name: "Brescia",
                lat: 45.5416,
                lon: 10.2118,
                country: "IT",
                population: 196745,
                themes: {
                    adventure: 0.5,
                    romantic: 0.5,
                    cultural: 0.8,
                    hidden: 0.6,
                    family: 0.6
                },
                activities: [
                    "Roman ruins exploration",
                    "Santa Giulia Museum",
                    "Brescia Castle hike",
                    "Piazza della Loggia"
                ]
            },
            {
                id: "pisa",
                name: "Pisa",
                lat: 43.7228,
                lon: 10.4017,
                country: "IT",
                population: 90118,
                themes: {
                    adventure: 0.3,
                    romantic: 0.6,
                    cultural: 0.9,
                    hidden: 0.2,
                    family: 0.8
                },
                activities: [
                    "Leaning Tower climb",
                    "Piazza dei Miracoli tour",
                    "Baptistery acoustics",
                    "Arno River walk"
                ]
            },
            {
                id: "la-spezia",
                name: "La Spezia",
                lat: 44.1069,
                lon: 9.8238,
                country: "IT",
                population: 93678,
                themes: {
                    adventure: 0.7,
                    romantic: 0.6,
                    cultural: 0.6,
                    hidden: 0.4,
                    family: 0.6
                },
                activities: [
                    "Naval Museum visit",
                    "Cinque Terre gateway",
                    "Castle of San Giorgio",
                    "Local seafood market"
                ]
            },
            // Alpine cities
            {
                id: "chamonix",
                name: "Chamonix",
                lat: 45.9237,
                lon: 6.8694,
                country: "FR",
                population: 8902,
                themes: {
                    adventure: 1.0,
                    romantic: 0.7,
                    cultural: 0.4,
                    hidden: 0.3,
                    family: 0.7
                },
                activities: [
                    "Aiguille du Midi cable car",
                    "Mer de Glace glacier train",
                    "Mont Blanc tunnel",
                    "Alpine hiking trails"
                ]
            },
            {
                id: "annecy",
                name: "Annecy",
                lat: 45.8992,
                lon: 6.1294,
                country: "FR",
                population: 128199,
                themes: {
                    adventure: 0.6,
                    romantic: 0.9,
                    cultural: 0.7,
                    hidden: 0.2,
                    family: 0.8
                },
                activities: [
                    "Lake Annecy boat cruise",
                    "Old Town canals walk",
                    "Château d'Annecy visit",
                    "Paragliding adventure"
                ]
            },
            {
                id: "grenoble",
                name: "Grenoble",
                lat: 45.1885,
                lon: 5.7245,
                country: "FR",
                population: 158454,
                themes: {
                    adventure: 0.8,
                    romantic: 0.5,
                    cultural: 0.7,
                    hidden: 0.3,
                    family: 0.6
                },
                activities: [
                    "Bastille cable car ride",
                    "Museum of Grenoble art",
                    "Vercors mountain excursions",
                    "Old Town exploration"
                ]
            },
            {
                id: "gap",
                name: "Gap",
                lat: 44.5598,
                lon: 6.0821,
                country: "FR",
                population: 40559,
                themes: {
                    adventure: 0.8,
                    romantic: 0.4,
                    cultural: 0.5,
                    hidden: 0.5,
                    family: 0.6
                },
                activities: [
                    "Serre-Ponçon Lake activities",
                    "National Park hiking",
                    "Gap Cathedral visit",
                    "Mountain biking trails"
                ]
            },
            {
                id: "chambery",
                name: "Chambéry",
                lat: 45.5646,
                lon: 5.9178,
                country: "FR",
                population: 59490,
                themes: {
                    adventure: 0.6,
                    romantic: 0.6,
                    cultural: 0.7,
                    hidden: 0.4,
                    family: 0.6
                },
                activities: [
                    "Château des Ducs de Savoie",
                    "Elephant Fountain landmark",
                    "Lake Bourget excursion",
                    "Old Town medieval streets"
                ]
            },
            // Provence circuit
            {
                id: "avignon",
                name: "Avignon",
                lat: 43.9493,
                lon: 4.8055,
                country: "FR",
                population: 92130,
                themes: {
                    adventure: 0.3,
                    romantic: 0.7,
                    cultural: 1.0,
                    hidden: 0.2,
                    family: 0.7
                },
                activities: [
                    "Papal Palace tour",
                    "Pont d'Avignon bridge",
                    "Festival d'Avignon theater",
                    "Les Halles market"
                ]
            },
            {
                id: "arles",
                name: "Arles",
                lat: 43.6761,
                lon: 4.6306,
                country: "FR",
                population: 52548,
                themes: {
                    adventure: 0.4,
                    romantic: 0.7,
                    cultural: 0.9,
                    hidden: 0.3,
                    family: 0.7
                },
                activities: [
                    "Roman amphitheater gladiators",
                    "Van Gogh trail walk",
                    "Alyscamps necropolis",
                    "Saturday market shopping"
                ]
            },
            {
                id: "nimes",
                name: "Nîmes",
                lat: 43.8367,
                lon: 4.3601,
                country: "FR",
                population: 151001,
                themes: {
                    adventure: 0.4,
                    romantic: 0.6,
                    cultural: 0.9,
                    hidden: 0.2,
                    family: 0.7
                },
                activities: [
                    "Arena of Nîmes concerts",
                    "Maison Carrée temple",
                    "Jardins de la Fontaine",
                    "Pont du Gard aqueduct"
                ]
            },
            {
                id: "salon-de-provence",
                name: "Salon-de-Provence",
                lat: 43.6403,
                lon: 5.0982,
                country: "FR",
                population: 45328,
                themes: {
                    adventure: 0.3,
                    romantic: 0.5,
                    cultural: 0.7,
                    hidden: 0.4,
                    family: 0.6
                },
                activities: [
                    "Nostradamus house museum",
                    "Savonnerie Marius Fabre soap",
                    "Château de l'Empéri",
                    "Wednesday market"
                ]
            },
            {
                id: "cavaillon",
                name: "Cavaillon",
                lat: 43.8387,
                lon: 5.0378,
                country: "FR",
                population: 26224,
                themes: {
                    adventure: 0.6,
                    romantic: 0.4,
                    cultural: 0.5,
                    hidden: 0.5,
                    family: 0.6
                },
                activities: [
                    "Via Ferrata climbing",
                    "Melon festival celebration",
                    "Saint-Jacques Hill hike",
                    "Roman arch discovery"
                ]
            },
            // Luberon villages
            {
                id: "lourmarin",
                name: "Lourmarin",
                lat: 43.7631,
                lon: 5.3596,
                country: "FR",
                population: 1119,
                themes: {
                    adventure: 0.3,
                    romantic: 0.9,
                    cultural: 0.7,
                    hidden: 0.6,
                    family: 0.5
                },
                activities: [
                    "Renaissance château visit",
                    "Friday market shopping",
                    "Albert Camus grave",
                    "Café terraces"
                ]
            },
            {
                id: "bonnieux",
                name: "Bonnieux",
                lat: 43.8233,
                lon: 5.3058,
                country: "FR",
                population: 1418,
                themes: {
                    adventure: 0.5,
                    romantic: 0.8,
                    cultural: 0.6,
                    hidden: 0.7,
                    family: 0.5
                },
                activities: [
                    "12th-century church climb",
                    "Cedar forest hike",
                    "Panoramic viewpoint",
                    "Local wine tasting"
                ]
            },
            {
                id: "roussillon",
                name: "Roussillon",
                lat: 43.9014,
                lon: 5.2942,
                country: "FR",
                population: 1305,
                themes: {
                    adventure: 0.6,
                    romantic: 0.8,
                    cultural: 0.7,
                    hidden: 0.5,
                    family: 0.7
                },
                activities: [
                    "Ochre Trail hike",
                    "Ochre cliffs photography",
                    "Artist galleries visit",
                    "Sunset viewpoint"
                ]
            },
            {
                id: "gordes",
                name: "Gordes",
                lat: 43.9106,
                lon: 5.2019,
                country: "FR",
                population: 2067,
                themes: {
                    adventure: 0.4,
                    romantic: 0.9,
                    cultural: 0.7,
                    hidden: 0.4,
                    family: 0.5
                },
                activities: [
                    "Village Castle visit",
                    "Sénanque Abbey lavender",
                    "Stone village walk",
                    "Terrace dining views"
                ]
            },
            // Verdon region
            {
                id: "moustiers-sainte-marie",
                name: "Moustiers-Sainte-Marie",
                lat: 43.8447,
                lon: 6.2200,
                country: "FR",
                population: 703,
                themes: {
                    adventure: 0.7,
                    romantic: 0.8,
                    cultural: 0.6,
                    hidden: 0.6,
                    family: 0.5
                },
                activities: [
                    "Pottery workshops visit",
                    "Chapel Notre-Dame hike",
                    "Golden star legend",
                    "Waterfall trail"
                ]
            },
            {
                id: "castellane",
                name: "Castellane",
                lat: 43.8469,
                lon: 6.5125,
                country: "FR",
                population: 1558,
                themes: {
                    adventure: 0.9,
                    romantic: 0.5,
                    cultural: 0.4,
                    hidden: 0.6,
                    family: 0.6
                },
                activities: [
                    "Verdon rafting base",
                    "Notre-Dame du Roc climb",
                    "Canyon entrance point",
                    "Saturday market"
                ]
            },
            // Coastal towns
            {
                id: "cassis",
                name: "Cassis",
                lat: 43.2148,
                lon: 5.5381,
                country: "FR",
                population: 7265,
                themes: {
                    adventure: 0.7,
                    romantic: 0.8,
                    cultural: 0.5,
                    hidden: 0.4,
                    family: 0.7
                },
                activities: [
                    "Calanques boat tour",
                    "Cap Canaille cliffs",
                    "Port-side dining",
                    "Beach swimming"
                ]
            },
            {
                id: "la-ciotat",
                name: "La Ciotat",
                lat: 43.1748,
                lon: 5.6045,
                country: "FR",
                population: 35281,
                themes: {
                    adventure: 0.6,
                    romantic: 0.6,
                    cultural: 0.5,
                    hidden: 0.5,
                    family: 0.7
                },
                activities: [
                    "Eden Theater cinema history",
                    "Shipyard heritage tour",
                    "Green Island boat trip",
                    "Lumière brothers museum"
                ]
            },
            {
                id: "bandol",
                name: "Bandol",
                lat: 43.1363,
                lon: 5.7484,
                country: "FR",
                population: 8577,
                themes: {
                    adventure: 0.5,
                    romantic: 0.8,
                    cultural: 0.6,
                    hidden: 0.4,
                    family: 0.7
                },
                activities: [
                    "Wine estate tours",
                    "Bendor Island excursion",
                    "Coastal path walk",
                    "Beach club relaxation"
                ]
            },
            {
                id: "toulon",
                name: "Toulon",
                lat: 43.1242,
                lon: 5.928,
                country: "FR",
                population: 171953,
                themes: {
                    adventure: 0.5,
                    romantic: 0.4,
                    cultural: 0.6,
                    hidden: 0.3,
                    family: 0.6
                },
                activities: [
                    "Naval Museum visit",
                    "Mont Faron cable car",
                    "Provençal market",
                    "Harbor boat tour"
                ]
            },
            {
                id: "hyeres",
                name: "Hyères",
                lat: 43.1205,
                lon: 6.1286,
                country: "FR",
                population: 55588,
                themes: {
                    adventure: 0.6,
                    romantic: 0.7,
                    cultural: 0.5,
                    hidden: 0.4,
                    family: 0.7
                },
                activities: [
                    "Golden Islands ferry",
                    "Villa Noailles architecture",
                    "Medieval old town",
                    "Salt marshes flamingos"
                ]
            },
            // Inland Provence
            {
                id: "manosque",
                name: "Manosque",
                lat: 43.8344,
                lon: 5.7869,
                country: "FR",
                population: 22349,
                themes: {
                    adventure: 0.4,
                    romantic: 0.5,
                    cultural: 0.6,
                    hidden: 0.5,
                    family: 0.6
                },
                activities: [
                    "L'Occitane factory tour",
                    "Jean Giono center",
                    "Old gates walk",
                    "Saturday market"
                ]
            },
            {
                id: "sisteron",
                name: "Sisteron",
                lat: 44.1948,
                lon: 5.9451,
                country: "FR",
                population: 7450,
                themes: {
                    adventure: 0.8,
                    romantic: 0.5,
                    cultural: 0.6,
                    hidden: 0.5,
                    family: 0.6
                },
                activities: [
                    "Citadel fortress visit",
                    "Via Ferrata climbing",
                    "Méouge Gorges swimming",
                    "Rock climbing spots"
                ]
            },
            {
                id: "forcalquier",
                name: "Forcalquier",
                lat: 43.9597,
                lon: 5.7797,
                country: "FR",
                population: 4982,
                themes: {
                    adventure: 0.5,
                    romantic: 0.6,
                    cultural: 0.6,
                    hidden: 0.7,
                    family: 0.5
                },
                activities: [
                    "Citadel panoramic views",
                    "Monday market experience",
                    "Observatory astronomy",
                    "Lavender distillery"
                ]
            },
            {
                id: "digne-les-bains",
                name: "Digne-les-Bains",
                lat: 44.0919,
                lon: 6.2358,
                country: "FR",
                population: 16333,
                themes: {
                    adventure: 0.7,
                    romantic: 0.4,
                    cultural: 0.5,
                    hidden: 0.6,
                    family: 0.6
                },
                activities: [
                    "Thermal spa relaxation",
                    "Geological Reserve",
                    "Lavender museum",
                    "Train des Pignes ride"
                ]
            },
            // Additional route cities
            {
                id: "saint-maximin",
                name: "Saint-Maximin-la-Sainte-Baume",
                lat: 43.4532,
                lon: 5.8642,
                country: "FR",
                population: 16900,
                themes: {
                    adventure: 0.4,
                    romantic: 0.5,
                    cultural: 0.8,
                    hidden: 0.5,
                    family: 0.5
                },
                activities: [
                    "Basilica Mary Magdalene",
                    "Royal Convent hotel",
                    "Organ concerts",
                    "Medieval market"
                ]
            },
            {
                id: "le-luc",
                name: "Le Luc",
                lat: 43.3909,
                lon: 6.3173,
                country: "FR",
                population: 8900,
                themes: {
                    adventure: 0.3,
                    romantic: 0.4,
                    cultural: 0.4,
                    hidden: 0.6,
                    family: 0.5
                },
                activities: [
                    "Hexagonal bell tower",
                    "Wine cooperative visit",
                    "Local market Friday",
                    "Historic center walk"
                ]
            },
            {
                id: "frejus",
                name: "Fréjus",
                lat: 43.4326,
                lon: 6.7365,
                country: "FR",
                population: 52389,
                themes: {
                    adventure: 0.5,
                    romantic: 0.6,
                    cultural: 0.7,
                    hidden: 0.3,
                    family: 0.7
                },
                activities: [
                    "Roman amphitheater",
                    "Aqueduct remains",
                    "Cathedral cloister",
                    "Beach activities"
                ]
            },
            {
                id: "mandelieu",
                name: "Mandelieu-la-Napoule",
                lat: 43.5487,
                lon: 6.9393,
                country: "FR",
                population: 22714,
                themes: {
                    adventure: 0.5,
                    romantic: 0.7,
                    cultural: 0.5,
                    hidden: 0.4,
                    family: 0.6
                },
                activities: [
                    "La Napoule Castle",
                    "Golf courses",
                    "Marina walks",
                    "Mimosa festival"
                ]
            },
            {
                id: "villeneuve-loubet",
                name: "Villeneuve-Loubet",
                lat: 43.633,
                lon: 7.1275,
                country: "FR",
                population: 14427,
                themes: {
                    adventure: 0.4,
                    romantic: 0.5,
                    cultural: 0.5,
                    hidden: 0.5,
                    family: 0.7
                },
                activities: [
                    "Marina Baie des Anges",
                    "Escoffier Museum cuisine",
                    "Beach park activities",
                    "Medieval village visit"
                ]
            },
            {
                id: "cagnes-sur-mer",
                name: "Cagnes-sur-Mer",
                lat: 43.6635,
                lon: 7.1491,
                country: "FR",
                population: 51049,
                themes: {
                    adventure: 0.4,
                    romantic: 0.6,
                    cultural: 0.7,
                    hidden: 0.4,
                    family: 0.6
                },
                activities: [
                    "Renoir Museum gardens",
                    "Haut-de-Cagnes medieval",
                    "Grimaldi Castle museum",
                    "Hippodrome racing"
                ]
            },
            // Italian coastal towns
            {
                id: "ventimiglia",
                name: "Ventimiglia",
                lat: 43.7923,
                lon: 7.6079,
                country: "IT",
                population: 24071,
                themes: {
                    adventure: 0.4,
                    romantic: 0.5,
                    cultural: 0.6,
                    hidden: 0.5,
                    family: 0.5
                },
                activities: [
                    "Hanbury Botanical Gardens",
                    "Friday market bargains",
                    "Old Town exploration",
                    "Beach promenade"
                ]
            },
            {
                id: "imperia",
                name: "Imperia",
                lat: 43.8851,
                lon: 8.0276,
                country: "IT",
                population: 42060,
                themes: {
                    adventure: 0.5,
                    romantic: 0.6,
                    cultural: 0.6,
                    hidden: 0.5,
                    family: 0.6
                },
                activities: [
                    "Olive Oil Museum",
                    "Porto Maurizio old town",
                    "Villa Grock park",
                    "Parasio district walk"
                ]
            },
            {
                id: "savona",
                name: "Savona",
                lat: 44.3071,
                lon: 8.481,
                country: "IT",
                population: 60853,
                themes: {
                    adventure: 0.4,
                    romantic: 0.5,
                    cultural: 0.7,
                    hidden: 0.5,
                    family: 0.6
                },
                activities: [
                    "Priamar Fortress",
                    "Sistine Chapel replica",
                    "Torre Leon Pancaldo",
                    "Local ceramics shopping"
                ]
            },
            {
                id: "finale-ligure",
                name: "Finale Ligure",
                lat: 44.1697,
                lon: 8.3442,
                country: "IT",
                population: 11665,
                themes: {
                    adventure: 0.8,
                    romantic: 0.7,
                    cultural: 0.5,
                    hidden: 0.7,
                    family: 0.7
                },
                activities: [
                    "Rock climbing paradise",
                    "Finalborgo medieval town",
                    "Beach activities",
                    "Mountain biking trails"
                ]
            },
            {
                id: "alassio",
                name: "Alassio",
                lat: 44.0063,
                lon: 8.1726,
                country: "IT",
                population: 10947,
                themes: {
                    adventure: 0.4,
                    romantic: 0.7,
                    cultural: 0.5,
                    hidden: 0.5,
                    family: 0.7
                },
                activities: [
                    "Muretto celebrity wall",
                    "Sandy beaches",
                    "Via Julia Augusta walk",
                    "English promenade"
                ]
            },
            // Additional Italian cities
            {
                id: "massa",
                name: "Massa",
                lat: 44.0366,
                lon: 10.1411,
                country: "IT",
                population: 68946,
                themes: {
                    adventure: 0.5,
                    romantic: 0.5,
                    cultural: 0.6,
                    hidden: 0.5,
                    family: 0.5
                },
                activities: [
                    "Malaspina Castle",
                    "Marble quarries tour",
                    "Ducal Palace visit",
                    "Beach resort area"
                ]
            },
            {
                id: "viareggio",
                name: "Viareggio",
                lat: 43.8717,
                lon: 10.2441,
                country: "IT",
                population: 62467,
                themes: {
                    adventure: 0.4,
                    romantic: 0.6,
                    cultural: 0.6,
                    hidden: 0.3,
                    family: 0.7
                },
                activities: [
                    "Carnival parade festival",
                    "Liberty architecture walk",
                    "Beach establishments",
                    "Pineta park cycling"
                ]
            },
            {
                id: "empoli",
                name: "Empoli",
                lat: 43.719,
                lon: 10.9464,
                country: "IT",
                population: 48626,
                themes: {
                    adventure: 0.3,
                    romantic: 0.4,
                    cultural: 0.6,
                    hidden: 0.6,
                    family: 0.5
                },
                activities: [
                    "Glass Museum visit",
                    "Collegiate Church art",
                    "Weekly market Thursday",
                    "Historic center stroll"
                ]
            },
            // Northern route cities
            {
                id: "pertuis",
                name: "Pertuis",
                lat: 43.6937,
                lon: 5.5028,
                country: "FR",
                population: 19459,
                themes: {
                    adventure: 0.3,
                    romantic: 0.4,
                    cultural: 0.5,
                    hidden: 0.5,
                    family: 0.5
                },
                activities: [
                    "Saint-Jacques church",
                    "Friday market shopping",
                    "Clock tower visit",
                    "Durance River walks"
                ]
            },
            // Wine route
            {
                id: "chateauneuf-du-pape",
                name: "Châteauneuf-du-Pape",
                lat: 44.0556,
                lon: 4.8306,
                country: "FR",
                population: 2179,
                themes: {
                    adventure: 0.3,
                    romantic: 0.8,
                    cultural: 0.7,
                    hidden: 0.4,
                    family: 0.4
                },
                activities: [
                    "Wine estate tastings",
                    "Château ruins sunset",
                    "Wine museum visit",
                    "Vineyard tours"
                ]
            },
            {
                id: "orange",
                name: "Orange",
                lat: 44.1361,
                lon: 4.8083,
                country: "FR",
                population: 29183,
                themes: {
                    adventure: 0.3,
                    romantic: 0.5,
                    cultural: 0.9,
                    hidden: 0.3,
                    family: 0.6
                },
                activities: [
                    "Roman Theatre performances",
                    "Triumphal Arch visit",
                    "Museum exhibitions",
                    "Old Town exploration"
                ]
            },
            {
                id: "vaison-la-romaine",
                name: "Vaison-la-Romaine",
                lat: 44.2417,
                lon: 5.0733,
                country: "FR",
                population: 6179,
                themes: {
                    adventure: 0.4,
                    romantic: 0.6,
                    cultural: 0.9,
                    hidden: 0.4,
                    family: 0.6
                },
                activities: [
                    "Roman ruins exploration",
                    "Medieval upper town",
                    "Roman bridge crossing",
                    "Tuesday market"
                ]
            },
            {
                id: "carpentras",
                name: "Carpentras",
                lat: 44.0550,
                lon: 5.0478,
                country: "FR",
                population: 28798,
                themes: {
                    adventure: 0.3,
                    romantic: 0.5,
                    cultural: 0.7,
                    hidden: 0.4,
                    family: 0.6
                },
                activities: [
                    "Friday truffle market",
                    "Synagogue oldest France",
                    "Berlingot candy tasting",
                    "Cathedral Saint-Siffrein"
                ]
            },
            // Rhône Valley
            {
                id: "montelimar",
                name: "Montélimar",
                lat: 44.5583,
                lon: 4.7506,
                country: "FR",
                population: 39352,
                themes: {
                    adventure: 0.3,
                    romantic: 0.4,
                    cultural: 0.5,
                    hidden: 0.4,
                    family: 0.7
                },
                activities: [
                    "Nougat factory tours",
                    "Château des Adhémar",
                    "Miniature museum",
                    "Wednesday market"
                ]
            },
            {
                id: "valence",
                name: "Valence",
                lat: 44.9333,
                lon: 4.8923,
                country: "FR",
                population: 62481,
                themes: {
                    adventure: 0.4,
                    romantic: 0.5,
                    cultural: 0.6,
                    hidden: 0.3,
                    family: 0.6
                },
                activities: [
                    "Kiosque Peynet landmark",
                    "Saint-Apollinaire Cathedral",
                    "Museum of Fine Arts",
                    "Jouvet Park stroll"
                ]
            },
            // Italian wine region
            {
                id: "alba",
                name: "Alba",
                lat: 44.7009,
                lon: 8.0353,
                country: "IT",
                population: 31420,
                themes: {
                    adventure: 0.3,
                    romantic: 0.7,
                    cultural: 0.7,
                    hidden: 0.5,
                    family: 0.4
                },
                activities: [
                    "White truffle hunting",
                    "Barolo wine tours",
                    "Medieval towers visit",
                    "Saturday truffle market"
                ]
            },
            {
                id: "asti",
                name: "Asti",
                lat: 44.9008,
                lon: 8.2064,
                country: "IT",
                population: 76211,
                themes: {
                    adventure: 0.3,
                    romantic: 0.6,
                    cultural: 0.7,
                    hidden: 0.4,
                    family: 0.5
                },
                activities: [
                    "Asti Spumante cellars",
                    "Palio horse race",
                    "Cathedral of Asti",
                    "Torre Rossa climb"
                ]
            },
            {
                id: "como",
                name: "Como",
                lat: 45.8080,
                lon: 9.0852,
                country: "IT",
                population: 85263,
                themes: {
                    adventure: 0.5,
                    romantic: 0.9,
                    cultural: 0.7,
                    hidden: 0.2,
                    family: 0.6
                },
                activities: [
                    "Lake Como boat tours",
                    "Funicular to Brunate",
                    "Como Cathedral visit",
                    "Villa Olmo gardens"
                ]
            },
            {
                id: "bergamo",
                name: "Bergamo",
                lat: 45.6983,
                lon: 9.6773,
                country: "IT",
                population: 120287,
                themes: {
                    adventure: 0.5,
                    romantic: 0.7,
                    cultural: 0.8,
                    hidden: 0.4,
                    family: 0.6
                },
                activities: [
                    "Città Alta walls walk",
                    "Funicular railway ride",
                    "Accademia Carrara art",
                    "Piazza Vecchia dining"
                ]
            },
            // Camargue region
            {
                id: "saintes-maries-de-la-mer",
                name: "Saintes-Maries-de-la-Mer",
                lat: 43.4519,
                lon: 4.4286,
                country: "FR",
                population: 2478,
                themes: {
                    adventure: 0.6,
                    romantic: 0.6,
                    cultural: 0.6,
                    hidden: 0.5,
                    family: 0.6
                },
                activities: [
                    "Fortified church visit",
                    "Gypsy pilgrimage festival",
                    "Horse riding beaches",
                    "Flamingo watching"
                ]
            },
            {
                id: "aigues-mortes",
                name: "Aigues-Mortes",
                lat: 43.5667,
                lon: 4.1903,
                country: "FR",
                population: 8560,
                themes: {
                    adventure: 0.4,
                    romantic: 0.6,
                    cultural: 0.8,
                    hidden: 0.4,
                    family: 0.6
                },
                activities: [
                    "Medieval ramparts walk",
                    "Tower of Constance",
                    "Salt works tour",
                    "Canal boat trips"
                ]
            },
            // Hidden gems
            {
                id: "caseneuve",
                name: "Caseneuve",
                lat: 44.0447,
                lon: 5.4247,
                country: "FR",
                population: 500,
                themes: {
                    adventure: 0.5,
                    romantic: 0.7,
                    cultural: 0.6,
                    hidden: 0.9,
                    family: 0.4
                },
                activities: [
                    "Medieval castle ruins",
                    "Largest oratory Provence",
                    "L'Authentic bistrot",
                    "Village panoramic views"
                ]
            },
            {
                id: "le-paradou",
                name: "Le Paradou",
                lat: 43.7167,
                lon: 4.7833,
                country: "FR",
                population: 400,
                themes: {
                    adventure: 0.3,
                    romantic: 0.8,
                    cultural: 0.5,
                    hidden: 0.9,
                    family: 0.5
                },
                activities: [
                    "Bistrot du Paradou dining",
                    "Queen Jeanne pavilion",
                    "Local artist galleries",
                    "Alpilles hiking trails"
                ]
            },
            {
                id: "eguilles",
                name: "Éguilles",
                lat: 43.5667,
                lon: 5.3500,
                country: "FR",
                population: 7826,
                themes: {
                    adventure: 0.3,
                    romantic: 0.7,
                    cultural: 0.5,
                    hidden: 0.8,
                    family: 0.5
                },
                activities: [
                    "Hilltop village views",
                    "Sunset terrace dining",
                    "Medieval castle remains",
                    "Local wine producers"
                ]
            },
            {
                id: "lamanon",
                name: "Lamanon",
                lat: 43.7042,
                lon: 5.0823,
                country: "FR",
                population: 2024,
                themes: {
                    adventure: 0.6,
                    romantic: 0.5,
                    cultural: 0.7,
                    hidden: 0.8,
                    family: 0.5
                },
                activities: [
                    "Grottes de Calès caves",
                    "116 troglodyte dwellings",
                    "Medieval chapel ruins",
                    "Nature trail hiking"
                ]
            }
        ];

        // Global variables
        let map;
        let routeLayer;
        let markersLayer;
        let currentRoute = null;
        let selectedTheme = 'balanced';

        // Initialize the application
        function initializeApp() {
            // Initialize map
            map = L.map('map').setView([43.5263, 5.4454], 8);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);
            
            routeLayer = L.layerGroup().addTo(map);
            markersLayer = L.layerGroup().addTo(map);

            // Add starting point marker
            L.marker([43.5263, 5.4454], {
                icon: L.divIcon({
                    className: 'custom-marker',
                    html: '<div style="background: #667eea; color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 3px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3);">A</div>',
                    iconSize: [32, 32],
                    iconAnchor: [16, 16]
                })
            }).addTo(markersLayer).bindPopup('<b>Aix-en-Provence</b><br>Starting Point');

            // Setup event listeners
            setupEventListeners();
            setupAutocomplete();
        }

        // Setup autocomplete functionality
        function setupAutocomplete() {
            const input = document.getElementById('destination');
            const dropdown = document.getElementById('autocomplete');
            
            input.addEventListener('input', function() {
                const value = this.value.toLowerCase();
                if (value.length < 2) {
                    dropdown.style.display = 'none';
                    return;
                }
                
                const matches = cities.filter(city => 
                    city.name.toLowerCase().includes(value) && city.id !== 'aix-en-provence'
                ).slice(0, 8);
                
                if (matches.length > 0) {
                    dropdown.innerHTML = matches.map(city => 
                        `<div class="autocomplete-item" data-id="${city.id}" data-name="${city.name}">
                            ${city.name} <span style="color: #999; font-size: 0.85rem;">(${city.country})</span>
                        </div>`
                    ).join('');
                    dropdown.style.display = 'block';
                    
                    // Add click handlers
                    dropdown.querySelectorAll('.autocomplete-item').forEach(item => {
                        item.addEventListener('click', function() {
                            input.value = this.dataset.name;
                            input.dataset.cityId = this.dataset.id;
                            dropdown.style.display = 'none';
                        });
                    });
                } else {
                    dropdown.style.display = 'none';
                }
            });
            
            // Hide dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!input.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.style.display = 'none';
                }
            });
        }

        // Setup event listeners
        function setupEventListeners() {
            // Theme selector
            document.querySelectorAll('.theme-button').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.theme-button').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    selectedTheme = this.dataset.theme;
                });
            });
            
            // Set default theme
            document.querySelector('[data-theme="balanced"]').classList.add('active');
            
            // Sliders
            document.getElementById('stops-slider').addEventListener('input', function() {
                document.getElementById('stops-value').textContent = this.value;
            });
            
            document.getElementById('detour-slider').addEventListener('input', function() {
                document.getElementById('detour-value').textContent = this.value + '%';
            });
            
            // Calculate button
            document.getElementById('calculate-btn').addEventListener('click', calculateRoute);
        }

        // Route calculation class
        class RouteCalculator {
            constructor() {
                this.cities = cities;
            }
            
            haversineDistance(city1, city2) {
                const R = 6371; // Earth radius in km
                const lat1 = city1.lat * Math.PI / 180;
                const lat2 = city2.lat * Math.PI / 180;
                const deltaLat = (city2.lat - city1.lat) * Math.PI / 180;
                const deltaLon = (city2.lon - city1.lon) * Math.PI / 180;
                
                const a = Math.sin(deltaLat/2) * Math.sin(deltaLat/2) +
                        Math.cos(lat1) * Math.cos(lat2) *
                        Math.sin(deltaLon/2) * Math.sin(deltaLon/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                
                return R * c;
            }
            
            getBoundingBox(start, end, bufferKm) {
                const latMin = Math.min(start.lat, end.lat) - (bufferKm / 111);
                const latMax = Math.max(start.lat, end.lat) + (bufferKm / 111);
                const lonMin = Math.min(start.lon, end.lon) - (bufferKm / (111 * Math.cos(start.lat * Math.PI / 180)));
                const lonMax = Math.max(start.lon, end.lon) + (bufferKm / (111 * Math.cos(start.lat * Math.PI / 180)));
                
                return { latMin, latMax, lonMin, lonMax };
            }
            
            calculateDetourFactor(city, start, end) {
                const directDistance = this.haversineDistance(start, end);
                const detourDistance = this.haversineDistance(start, city) + this.haversineDistance(city, end);
                return (detourDistance - directDistance) / directDistance;
            }
            
            selectOptimalStops(candidates, start, end, numStops, theme) {
                // Score candidates based on theme and detour
                const scored = candidates.map(city => {
                    const themeScore = theme === 'balanced' 
                        ? (city.themes.adventure + city.themes.romantic + city.themes.cultural + 
                           city.themes.hidden + city.themes.family) / 5
                        : city.themes[theme] || 0;
                    
                    const detourFactor = this.calculateDetourFactor(city, start, end);
                    const detourPenalty = Math.max(0, 1 - detourFactor * 2);
                    
                    return {
                        city,
                        score: themeScore * 0.7 + detourPenalty * 0.3
                    };
                });
                
                // Sort by score and select top candidates
                scored.sort((a, b) => b.score - a.score);
                return scored.slice(0, Math.min(numStops * 2, scored.length)).map(s => s.city);
            }
            
            orderStopsGeographically(stops, start, end) {
                // Order stops along the route direction
                const ordered = [];
                let current = start;
                const remaining = [...stops];
                
                while (remaining.length > 0) {
                    let nearest = null;
                    let nearestDist = Infinity;
                    let nearestIdx = -1;
                    
                    for (let i = 0; i < remaining.length; i++) {
                        const dist = this.haversineDistance(current, remaining[i]) + 
                                    this.haversineDistance(remaining[i], end);
                        if (dist < nearestDist) {
                            nearestDist = dist;
                            nearest = remaining[i];
                            nearestIdx = i;
                        }
                    }
                    
                    if (nearest) {
                        ordered.push(nearest);
                        current = nearest;
                        remaining.splice(nearestIdx, 1);
                    }
                }
                
                return ordered;
            }
            
            calculateRoute(startId, destId, options) {
                const start = this.cities.find(c => c.id === startId);
                const dest = this.cities.find(c => c.id === destId);
                
                if (!start || !dest) {
                    throw new Error('Invalid start or destination city');
                }
                
                const numStops = parseInt(options.numStops);
                const detourTolerance = parseInt(options.detourTolerance) / 100;
                const theme = options.theme;
                
                // Stage 1: Bounding box filter
                const directDistance = this.haversineDistance(start, dest);
                const bufferKm = directDistance * 0.3;
                const bbox = this.getBoundingBox(start, dest, bufferKm);
                
                let candidates = this.cities.filter(city => 
                    city.id !== startId && 
                    city.id !== destId &&
                    city.lat >= bbox.latMin && 
                    city.lat <= bbox.latMax &&
                    city.lon >= bbox.lonMin && 
                    city.lon <= bbox.lonMax
                );
                
                // Stage 2: Ellipse filter based on detour tolerance
                candidates = candidates.filter(city => {
                    const detour = this.calculateDetourFactor(city, start, dest);
                    return detour <= detourTolerance;
                });
                
                // Stage 3: Theme-based scoring and selection
                const selectedStops = this.selectOptimalStops(candidates, start, dest, numStops, theme);
                
                // Order stops geographically
                const orderedStops = this.orderStopsGeographically(
                    selectedStops.slice(0, numStops), 
                    start, 
                    dest
                );
                
                // Build final route
                const route = [start, ...orderedStops, dest];
                
                // Calculate total distance and time
                let totalDistance = 0;
                for (let i = 0; i < route.length - 1; i++) {
                    totalDistance += this.haversineDistance(route[i], route[i + 1]);
                }
                
                const totalTime = totalDistance / 80; // Assume 80 km/h average
                
                return {
                    route,
                    totalDistance: Math.round(totalDistance),
                    totalTime: totalTime.toFixed(1)
                };
            }
        }

        // Calculate route function
        function calculateRoute() {
            const destInput = document.getElementById('destination');
            const destName = destInput.value.trim();
            
            if (!destName) {
                alert('Please enter a destination');
                return;
            }
            
            // Find destination city
            const destCity = cities.find(c => 
                c.name.toLowerCase() === destName.toLowerCase() ||
                c.name.toLowerCase().includes(destName.toLowerCase())
            );
            
            if (!destCity) {
                alert('Destination not found. Please select from the suggestions.');
                return;
            }
            
            const calculator = new RouteCalculator();
            
            try {
                const result = calculator.calculateRoute('aix-en-provence', destCity.id, {
                    numStops: document.getElementById('stops-slider').value,
                    detourTolerance: document.getElementById('detour-slider').value,
                    theme: selectedTheme
                });
                
                currentRoute = result;
                displayRoute(result);
                updateRouteInfo(result);
                
            } catch (error) {
                alert('Error calculating route: ' + error.message);
            }
        }

        // Display route on map
        function displayRoute(routeData) {
            // Clear existing route
            routeLayer.clearLayers();
            markersLayer.clearLayers();
            
            const { route } = routeData;
            
            // Add markers
            route.forEach((city, index) => {
                const isStart = index === 0;
                const isEnd = index === route.length - 1;
                const label = isStart ? 'A' : (isEnd ? 'B' : index.toString());
                const color = isStart ? '#667eea' : (isEnd ? '#764ba2' : '#00c9ff');
                
                const marker = L.marker([city.lat, city.lon], {
                    icon: L.divIcon({
                        className: 'custom-marker',
                        html: `<div style="background: ${color}; color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 3px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3);">${label}</div>`,
                        iconSize: [32, 32],
                        iconAnchor: [16, 16]
                    })
                }).addTo(markersLayer);
                
                const popupContent = `<b>${city.name}</b><br>${city.country}<br>Pop: ${city.population.toLocaleString()}`;
                marker.bindPopup(popupContent);
            });
            
            // Draw route line
            const coordinates = route.map(city => [city.lat, city.lon]);
            const polyline = L.polyline(coordinates, {
                color: '#667eea',
                weight: 4,
                opacity: 0.7,
                smoothFactor: 1
            }).addTo(routeLayer);
            
            // Fit map to route
            map.fitBounds(polyline.getBounds().pad(0.1));
        }

        // Update route information panel
        function updateRouteInfo(routeData) {
            const { route, totalDistance, totalTime } = routeData;
            
            document.getElementById('total-distance').textContent = totalDistance;
            document.getElementById('total-time').textContent = totalTime;
            document.getElementById('total-stops').textContent = route.length - 2;
            
            // Display stops
            const stopsList = document.getElementById('stops-list');
            stopsList.innerHTML = '<h3 style="margin-bottom: 1rem;">Route Stops</h3>';
            
            route.forEach((city, index) => {
                if (index === 0 || index === route.length - 1) return;
                
                const stopCard = document.createElement('div');
                stopCard.className = 'stop-card';
                stopCard.innerHTML = `
                    <div class="stop-number">${index}</div>
                    <div class="stop-content">
                        <div class="stop-name">${city.name}</div>
                        <div class="stop-activities">
                            ${city.activities.slice(0, 2).join(' • ')}
                        </div>
                    </div>
                    <button class="stop-remove" onclick="removeStop(${index})">Remove</button>
                `;
                stopsList.appendChild(stopCard);
            });
            
            document.getElementById('route-info').style.display = 'block';
        }

        // Remove stop from route
        function removeStop(index) {
            if (!currentRoute) return;
            
            const newRoute = [...currentRoute.route];
            newRoute.splice(index, 1);
            
            // Recalculate distance
            let totalDistance = 0;
            for (let i = 0; i < newRoute.length - 1; i++) {
                const calculator = new RouteCalculator();
                totalDistance += calculator.haversineDistance(newRoute[i], newRoute[i + 1]);
            }
            
            currentRoute = {
                route: newRoute,
                totalDistance: Math.round(totalDistance),
                totalTime: (totalDistance / 80).toFixed(1)
            };
            
            displayRoute(currentRoute);
            updateRouteInfo(currentRoute);
        }

        // Export to Google Maps
        function exportToGoogle() {
            if (!currentRoute) {
                alert('Please calculate a route first');
                return;
            }
            
            const waypoints = currentRoute.route.map(city => 
                encodeURIComponent(city.name)
            ).join('/');
            
            const url = `https://www.google.com/maps/dir/${waypoints}`;
            window.open(url, '_blank');
        }

        // Export GPX file
        function exportGPX() {
            if (!currentRoute) {
                alert('Please calculate a route first');
                return;
            }
            
            const gpx = `<?xml version="1.0" encoding="UTF-8"?>
<gpx version="1.1" creator="Aix Road Trip Planner">
  <rte>
    <name>Road Trip from Aix-en-Provence</name>
    ${currentRoute.route.map((city, index) => `
    <rtept lat="${city.lat}" lon="${city.lon}">
      <name>${city.name}</name>
      <desc>${city.activities[0]}</desc>
    </rtept>`).join('')}
  </rte>
</gpx>`;
            
            const blob = new Blob([gpx], { type: 'application/gpx+xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'roadtrip.gpx';
            a.click();
            URL.revokeObjectURL(url);
        }

        // AI Features
        async function callPerplexityAPI(prompt) {
            const apiKey = document.getElementById('api-key').value;
            if (!apiKey) {
                alert('Please enter your Perplexity API key');
                return null;
            }
            
            try {
                const response = await fetch('https://api.perplexity.ai/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'llama-3.1-sonar-small-128k-online',
                        messages: [
                            {
                                role: 'user',
                                content: prompt
                            }
                        ]
                    })
                });
                
                if (!response.ok) {
                    throw new Error('API request failed');
                }
                
                const data = await response.json();
                return data.choices[0].message.content;
            } catch (error) {
                console.error('API Error:', error);
                alert('Error calling Perplexity API. Please check your API key.');
                return null;
            }
        }

        async function aiTripNarrator() {
            if (!currentRoute) {
                alert('Please calculate a route first');
                return;
            }
            
            const cityNames = currentRoute.route.map(c => c.name).join(', ');
            const prompt = `Write a poetic and inspiring description of a road trip through these cities: ${cityNames}. Focus on the journey, landscapes, and emotions. Keep it under 200 words.`;
            
            showAILoading('Trip Narrator');
            const result = await callPerplexityAPI(prompt);
            if (result) {
                showAIResult('Trip Narrator', result);
            }
        }

        async function aiLocalFood() {
            if (!currentRoute) {
                alert('Please calculate a route first');
                return;
            }
            
            const cityNames = currentRoute.route.map(c => c.name).join(', ');
            const prompt = `List the best local restaurants and must-try dishes in these cities: ${cityNames}. Include specific restaurant names and their specialties.`;
            
            showAILoading('Local Food Guide');
            const result = await callPerplexityAPI(prompt);
            if (result) {
                showAIResult('Local Food Guide', result);
            }
        }

        async function aiWeatherAdvice() {
            if (!currentRoute) {
                alert('Please calculate a route first');
                return;
            }
            
            const destination = currentRoute.route[currentRoute.route.length - 1].name;
            const prompt = `What is the current weather and best time to visit ${destination}? Include seasonal highlights and what to pack.`;
            
            showAILoading('Weather & Best Time');
            const result = await callPerplexityAPI(prompt);
            if (result) {
                showAIResult('Weather & Best Time', result);
            }
        }

        async function aiHiddenGems() {
            if (!currentRoute) {
                alert('Please calculate a route first');
                return;
            }
            
            const cityNames = currentRoute.route.map(c => c.name).join(', ');
            const prompt = `What are the hidden gems and secret spots that tourists usually miss in these cities: ${cityNames}? Include specific locations and insider tips.`;
            
            showAILoading('Hidden Gems');
            const result = await callPerplexityAPI(prompt);
            if (result) {
                showAIResult('Hidden Gems', result);
            }
        }

        async function aiItinerary() {
            if (!currentRoute) {
                alert('Please calculate a route first');
                return;
            }
            
            const cityNames = currentRoute.route.map(c => c.name).join(', ');
            const days = Math.ceil(currentRoute.route.length / 2);
            const prompt = `Create a detailed ${days}-day itinerary for this route: ${cityNames}. Include specific times, activities, restaurants, and budget estimates.`;
            
            showAILoading('Full Itinerary');
            const result = await callPerplexityAPI(prompt);
            if (result) {
                showAIResult('Full Itinerary', result);
            }
        }

        function showAILoading(title) {
            const aiResults = document.getElementById('ai-results');
            const aiTitle = document.getElementById('ai-title');
            const aiContent = document.getElementById('ai-content');
            
            aiResults.classList.add('active');
            aiTitle.innerHTML = title + ' <span class="loading"></span>';
            aiContent.textContent = 'Loading...';
        }

        function showAIResult(title, content) {
            const aiResults = document.getElementById('ai-results');
            const aiTitle = document.getElementById('ai-title');
            const aiContent = document.getElementById('ai-content');
            
            aiResults.classList.add('active');
            aiTitle.textContent = title;
            aiContent.textContent = content;
        }

        // Initialize app when DOM is loaded
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>